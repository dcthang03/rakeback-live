<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Dealer – All In One (FIX FULL)</title>

<style>
/* ===== GLOBAL LOCK ===== */
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;
  overscroll-behavior: none;
  touch-action: manipulation;
  background: #0e0e11;
  color: #fff;
  font-family: system-ui, sans-serif;
}

input, button { font-size: 16px; }

/* ===== LOGIN ===== */
#loginView {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}
#loginBox {
  width: 260px;
  background: #000;
  padding: 16px;
  border-radius: 12px;
}
#loginBox input,
#loginBox button {
  width: 100%;
  padding: 10px;
  margin-top: 10px;
  border-radius: 8px;
  border: none;
}
#loginBox button {
  background: #0a84ff;
  color: #fff;
}

/* ===== PANEL ===== */
#panelView {
  display: none;
  width: 100%;
  height: 100%;
}

/* ===== TABLE ===== */
.table-area {
  width: 100vw;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  transform: translateY(-12vh);
}
.table {
  position: relative;
  width: 270px;
  height: 190px;
  border-radius: 200px;
  background: radial-gradient(circle, #1c1c1c, #0f0f0f 70%);
  border: 4px solid #2a2a2a;
}
.seat {
  position: absolute;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: #1f2937;
  border: 2px solid #374151;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  cursor: pointer;
  user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
  touch-action: none;
}
.seat.occupied {
  background: #0a84ff;
  border-color: #0a84ff;
}
.seat small {
  font-size: 10px;
  opacity: .9;
}
</style>
</head>

<body>

<!-- ===== LOGIN VIEW ===== -->
<div id="loginView">
  <div id="loginBox">
    <h3 style="margin:0">Dealer Login</h3>
    <input id="tableInput" placeholder="Table ID (vd: A1)" />
    <button id="enterBtn">Enter</button>
  </div>
</div>

<!-- ===== PANEL VIEW ===== -->
<div id="panelView">
  <div class="table-area">
    <div class="table" id="table"></div>
  </div>
</div>

<!-- ===== QR MODAL ===== -->
<div id="qrModal" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
">
  <div style="width:260px;background:#000;padding:12px;border-radius:12px">
    <div id="qr-reader" style="width:100%; min-height:240px"></div>
    <button id="closeQR" style="
      width:100%;
      margin-top:10px;
      padding:10px;
      border:none;
      border-radius:8px;
      background:#374151;
      color:#fff;
      font-size:16px;
    ">Cancel</button>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* ===== LOCK ZOOM ===== */
document.addEventListener('gesturestart', e => e.preventDefault());
document.addEventListener('gesturechange', e => e.preventDefault());
document.addEventListener('gestureend', e => e.preventDefault());

/* ===== LOGIN ===== */
let TABLE_ID = null

document.getElementById('enterBtn').onclick = () => {
  const v = document.getElementById('tableInput').value.trim()
  if (!v) return alert('Nhập Table ID')

  TABLE_ID = v
  document.getElementById('loginView').style.display = 'none'
  document.getElementById('panelView').style.display = 'block'

  initPanel()
}

/* ===== SUPABASE ===== */
const SUPABASE_URL = 'https://ymtmipkmknnsqleahlmi.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltdG1pcGtta25uc3FsZWFobG1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwOTU1MjUsImV4cCI6MjA4NTY3MTUyNX0.7pEza-TKBKJ_xqdBu93nLo-PRaHDcDIxW-bjZnrFJxw'
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

/* ===== CONFIG ===== */
const SEAT_COUNT = 9
const TOP_SEAT = 5
const SEAT_SIZE = 60
const TABLE_BORDER = 4
const SAFE_PADDING = 8
const HOLD_TIME = 700

const seatState = {}
const seats = {}
let holdTimer = null
const tableEl = document.getElementById('table')

/* ===== INIT PANEL ===== */
function initPanel() {
  createSeats()
  renderSeats()
  loadSeats()
  initRealtime()
  window.addEventListener('resize', renderSeats)
}

/* ===== SEATS ===== */
function createSeats() {
  for (let i = 1; i <= SEAT_COUNT; i++) {
    seatState[i] = { uid: null }

    const seat = document.createElement('div')
    seat.className = 'seat'

    const num = document.createElement('div')
    num.textContent = i
    const uidEl = document.createElement('small')

    seat.appendChild(num)
    seat.appendChild(uidEl)

    seat.addEventListener('pointerdown', () => {
      clearTimeout(holdTimer)
      holdTimer = setTimeout(() => {
        if (seatState[i].uid) {
          if (confirm(`Reject UID ${seatState[i].uid.slice(0,6)} ?`)) {
            ejectUID(i)
          }
        } else {
          scanQRAndAssign(i)
        }
      }, HOLD_TIME)
    })

    seat.addEventListener('pointerup', () => clearTimeout(holdTimer))
    seat.addEventListener('pointerleave', () => clearTimeout(holdTimer))
    seat.addEventListener('pointercancel', () => clearTimeout(holdTimer))

    seats[i] = { el: seat, uidEl }
    tableEl.appendChild(seat)
  }
}

/* ===== RENDER ===== */
function renderSeats() {
  const rect = tableEl.getBoundingClientRect()
  const cx = rect.width / 2
  const cy = rect.height / 2
  const rX = cx - SEAT_SIZE/2 - TABLE_BORDER - SAFE_PADDING + 50
  const rY = cy - SEAT_SIZE/2 - TABLE_BORDER - SAFE_PADDING + 50

  for (let i = 1; i <= SEAT_COUNT; i++) {
    const { el, uidEl } = seats[i]
    const angle = (Math.PI*2/SEAT_COUNT)*(i-TOP_SEAT) - Math.PI/2

    el.style.left = cx + Math.cos(angle)*rX + 'px'
    el.style.top  = cy + Math.sin(angle)*rY + 'px'
    el.style.transform = 'translate(-50%,-50%)'

    el.classList.toggle('occupied', !!seatState[i].uid)
    uidEl.textContent = seatState[i].uid ? seatState[i].uid.slice(0,4) : ''
  }
}

/* ===== DB ===== */
async function assignUID(seat, uid) {
  seatState[seat].uid = uid
  renderSeats()

  const { data, error } = await sb
    .from('seats')
    .update({ uid })
    .eq('table_id', TABLE_ID)
    .eq('seat_number', String(seat))
    .select()

  if (error || !data?.length) {
    seatState[seat].uid = null
    renderSeats()
    alert('❌ Gán UID thất bại')
  }
}

async function ejectUID(seat) {
  const old = seatState[seat].uid
  seatState[seat].uid = null
  renderSeats()

  const { data, error } = await sb
    .from('seats')
    .update({ uid: null })
    .eq('table_id', TABLE_ID)
    .eq('seat_number', String(seat))
    .select()

  if (error || !data?.length) {
    seatState[seat].uid = old
    renderSeats()
    alert('❌ Reject thất bại')
  }
}

async function loadSeats() {
  const { data } = await sb
    .from('seats')
    .select('*')
    .eq('table_id', TABLE_ID)

  data?.forEach(r => {
    seatState[String(r.seat_number)].uid = r.uid
  })
  renderSeats()
}

/* ===== REALTIME ===== */
function initRealtime() {
  sb.channel('seats-' + TABLE_ID)
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'seats',
        filter: `table_id=eq.${TABLE_ID}`
      },
      p => {
        seatState[p.new.seat_number].uid = p.new.uid
        renderSeats()
      }
    )
    .subscribe()
}

/* ===== QR ===== */
let qrScanner = null

async function scanQRAndAssign(seatIndex) {
  const modal = document.getElementById('qrModal')
  const closeBtn = document.getElementById('closeQR')

  modal.style.display = 'flex'
  await safeStopQR()

  setTimeout(async () => {
    qrScanner = new Html5Qrcode('qr-reader')
    qrScanner.start(
      { facingMode: 'environment' },
      { fps: 10, qrbox: 220, aspectRatio: 1 },
      async text => {
        await safeStopQR()
        modal.style.display = 'none'

        const uid = text?.trim().replace(/[^a-zA-Z0-9]/g,'').toUpperCase()
        if (!uid) return alert('QR không hợp lệ')
        assignUID(seatIndex, uid)
      }
    )
  }, 150)

  closeBtn.onclick = async () => {
    await safeStopQR()
    modal.style.display = 'none'
  }
}

async function safeStopQR() {
  if (qrScanner) {
    try {
      if (qrScanner.isScanning) await qrScanner.stop()
      await qrScanner.clear()
    } catch(e){}
    qrScanner = null
  }
}

console.log('dealer1.html – FIX FULL OK')
</script>

</body>
</html>
